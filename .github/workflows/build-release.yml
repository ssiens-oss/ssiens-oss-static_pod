name: Build & Release Signed APT Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  PACKAGE_NAME: staticwaves-pod
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev dpkg-sig gnupg2

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0-dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update package version
        run: |
          sed -i "s/Version: .*/Version: ${{ steps.version.outputs.VERSION }}/" debian-pkg/DEBIAN/control

      - name: Build .deb package
        run: |
          chmod +x build-deb.sh
          ./build-deb.sh

      - name: Import GPG key
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --quick-sign-key ops@staticwaves.io

      - name: Sign package
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          dpkg-sig --sign builder staticwaves-pod_*.deb

      - name: Verify package
        run: |
          dpkg-deb --info staticwaves-pod_*.deb
          dpkg-sig --verify staticwaves-pod_*.deb || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            staticwaves-pod_*.deb
          body: |
            ## StaticWaves POD v${{ steps.version.outputs.VERSION }}

            ### Installation

            ```bash
            # Download and install
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/staticwaves-pod_${{ steps.version.outputs.VERSION }}_amd64.deb
            sudo dpkg -i staticwaves-pod_${{ steps.version.outputs.VERSION }}_amd64.deb
            sudo apt --fix-broken install
            ```

            ### Quick Start

            ```bash
            # Configure API keys
            sudo nano /opt/staticwaves-pod/config/.env

            # Start services
            sudo systemctl start staticwaves-pod-worker

            # Check status
            sudo systemctl status staticwaves-pod-api
            ```

            ### What's Included

            - ✅ Flask API server
            - ✅ ComfyUI worker integration
            - ✅ Automated mockup generation
            - ✅ Printify/Shopify/TikTok publishing
            - ✅ License enforcement
            - ✅ Systemd services

            ### Documentation

            - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/POD_STACK.md)
            - [API Reference](https://github.com/${{ github.repository }}/blob/main/API.md)
            - [Configuration](https://github.com/${{ github.repository }}/blob/main/CONFIGURATION.md)

      - name: Upload to APT repository
        if: ${{ secrets.APT_REPO_SSH_KEY != '' && startsWith(github.ref, 'refs/tags/') }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.APT_REPO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.APT_REPO_HOST }} >> ~/.ssh/known_hosts

          # Upload package
          scp staticwaves-pod_*.deb ${{ secrets.APT_REPO_USER }}@${{ secrets.APT_REPO_HOST }}:/var/www/apt/pool/main/s/staticwaves-pod/

          # Regenerate repository metadata
          ssh ${{ secrets.APT_REPO_USER }}@${{ secrets.APT_REPO_HOST }} 'cd /var/www/apt && ./update-repo.sh'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: staticwaves-pod-deb
          path: staticwaves-pod_*.deb
          retention-days: 90

  build-white-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        client:
          - id: demo
            tier: solo
            expires: "2025-12-31"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev dpkg-sig

      - name: Build white-label package
        run: |
          chmod +x build-whitelabel.sh
          ./build-whitelabel.sh ${{ matrix.client.id }} ${{ matrix.client.tier }} ${{ matrix.client.expires }}

      - name: Upload white-label artifact
        uses: actions/upload-artifact@v4
        with:
          name: staticwaves-pod-client-${{ matrix.client.id }}
          path: staticwaves-pod-client-${{ matrix.client.id }}_*.deb
          retention-days: 30
