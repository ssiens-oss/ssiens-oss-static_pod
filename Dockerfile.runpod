# RunPod Dockerfile with ComfyUI and POD Pipeline
# Production-ready environment for the POD automation pipeline

FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    COMFYUI_PATH=/workspace/ComfyUI \
    POD_APP_PATH=/workspace/app \
    NODE_ENV=production \
    PORT=80

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    git \
    wget \
    curl \
    nginx \
    chromium-browser \
    chromium-chromedriver \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Create workspace directories
WORKDIR /workspace
RUN mkdir -p ${COMFYUI_PATH} ${POD_APP_PATH} /data/designs /data/chrome-profile

# Install ComfyUI
RUN git clone https://github.com/comfyanonymous/ComfyUI.git ${COMFYUI_PATH}
WORKDIR ${COMFYUI_PATH}
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 \
    && pip3 install -r requirements.txt

# Download SDXL model (optional - can be downloaded at runtime)
# RUN mkdir -p models/checkpoints && \
#     wget -O models/checkpoints/sd_xl_base_1.0.safetensors \
#     https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors

# Copy POD application
WORKDIR ${POD_APP_PATH}
COPY package*.json ./
RUN npm ci

# Copy application files
COPY . .

# Build frontend for production
RUN npm run build && \
    npm prune --production && \
    npm cache clean --force

# Copy built frontend to nginx html directory
RUN mkdir -p /usr/share/nginx/html && \
    cp -r dist/* /usr/share/nginx/html/

# Install POD Gateway
WORKDIR /workspace/gateway
COPY gateway/requirements.txt ./
RUN pip3 install -r requirements.txt
COPY gateway/ ./

# Configure environment defaults
RUN cp .env.example .env 2>/dev/null || true

# Configure Nginx
COPY nginx.conf /etc/nginx/sites-available/default
RUN rm -f /etc/nginx/sites-enabled/default && \
    ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Create necessary directories with proper permissions
RUN mkdir -p /data/designs /data/chrome-profile /data/comfyui/output && \
    chmod -R 755 /data

# Expose ports
# 80: Frontend web UI
# 8188: ComfyUI API
# 5000: POD Gateway
EXPOSE 80 8188 5000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/health && curl -f http://localhost:8188/system_stats || exit 1

# Create startup script
COPY <<'EOF' /start.sh
#!/bin/bash
set -e

echo "ðŸš€ Starting POD Pipeline Production Environment..."

# Start ComfyUI
echo "âš™ï¸  Starting ComfyUI..."
cd /workspace/ComfyUI
python3 main.py --listen 0.0.0.0 --port 8188 > /var/log/comfyui.log 2>&1 &
COMFYUI_PID=$!

# Wait for ComfyUI to be ready
echo "â³ Waiting for ComfyUI to initialize..."
for i in {1..30}; do
    if curl -sf http://localhost:8188/system_stats > /dev/null 2>&1; then
        echo "âœ… ComfyUI is ready"
        break
    fi
    echo "   Attempt $i/30..."
    sleep 2
done

# Start POD Gateway
echo "ðŸŽ¨ Starting POD Gateway..."
cd /workspace/gateway
python3 app/main.py > /var/log/gateway.log 2>&1 &
GATEWAY_PID=$!
echo "âœ… POD Gateway started (PID: $GATEWAY_PID)"

# Test Nginx configuration
echo "ðŸ” Testing Nginx configuration..."
nginx -t

# Start Nginx
echo "ðŸŒ Starting Nginx..."
nginx

echo ""
echo "âœ… All services started successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š Frontend Dashboard: http://localhost"
echo "ðŸŽ¨ ComfyUI API:        http://localhost:8188"
echo "ðŸ–¼ï¸  POD Gateway:        http://localhost:5000"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Monitor services
while true; do
    if ! kill -0 $COMFYUI_PID 2>/dev/null; then
        echo "âŒ ComfyUI process died, restarting..."
        cd /workspace/ComfyUI
        python3 main.py --listen 0.0.0.0 --port 8188 > /var/log/comfyui.log 2>&1 &
        COMFYUI_PID=$!
    fi

    if ! kill -0 $GATEWAY_PID 2>/dev/null; then
        echo "âŒ Gateway process died, restarting..."
        cd /workspace/gateway
        python3 app/main.py > /var/log/gateway.log 2>&1 &
        GATEWAY_PID=$!
    fi

    sleep 10
done
EOF

RUN chmod +x /start.sh

# Set up log directory
RUN mkdir -p /var/log && touch /var/log/comfyui.log /var/log/gateway.log

# Create gateway state directory
RUN mkdir -p /workspace/gateway-state

CMD ["/start.sh"]
