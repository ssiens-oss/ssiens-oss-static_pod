# RunPod Dockerfile with ComfyUI and POD Pipeline GUI
# This Dockerfile sets up a complete environment for the POD automation pipeline

FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV COMFYUI_PATH=/workspace/ComfyUI
ENV POD_APP_PATH=/workspace/app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    git \
    wget \
    curl \
    nginx \
    chromium-browser \
    chromium-chromedriver \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Create workspace directories
WORKDIR /workspace
RUN mkdir -p ${COMFYUI_PATH} ${POD_APP_PATH} /data/designs /data/chrome-profile

# Install ComfyUI
RUN git clone https://github.com/comfyanonymous/ComfyUI.git ${COMFYUI_PATH}
WORKDIR ${COMFYUI_PATH}
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 \
    && pip3 install -r requirements.txt

# Copy POD application
WORKDIR ${POD_APP_PATH}
COPY package*.json ./
RUN npm ci

# Copy application files
COPY . .

# Build all frontends
RUN npm run build && \
    npm run build:pod && \
    npm run build:music

# Configure Nginx to serve multiple apps
RUN echo 'events {\n\
    worker_connections 1024;\n\
}\n\
\n\
http {\n\
    include /etc/nginx/mime.types;\n\
    default_type application/octet-stream;\n\
\n\
    # POD Pipeline GUI (Main - Port 80)\n\
    server {\n\
        listen 80;\n\
        server_name _;\n\
\n\
        root /workspace/app/dist-pod;\n\
        index index.html;\n\
\n\
        location / {\n\
            try_files $uri $uri/ /index.html;\n\
        }\n\
\n\
        # Health check endpoint\n\
        location /health {\n\
            return 200 "OK";\n\
            add_header Content-Type text/plain;\n\
        }\n\
\n\
        # Proxy to ComfyUI API\n\
        location /comfyui/ {\n\
            proxy_pass http://localhost:8188/;\n\
            proxy_http_version 1.1;\n\
            proxy_set_header Upgrade $http_upgrade;\n\
            proxy_set_header Connection "upgrade";\n\
            proxy_set_header Host $host;\n\
        }\n\
    }\n\
\n\
    # Original POD Studio (Port 8080)\n\
    server {\n\
        listen 8080;\n\
        server_name _;\n\
\n\
        root /workspace/app/dist;\n\
        index index.html;\n\
\n\
        location / {\n\
            try_files $uri $uri/ /index.html;\n\
        }\n\
    }\n\
\n\
    # Music Studio (Port 8081)\n\
    server {\n\
        listen 8081;\n\
        server_name _;\n\
\n\
        root /workspace/app/dist-music;\n\
        index index.html;\n\
\n\
        location / {\n\
            try_files $uri $uri/ /index.html;\n\
        }\n\
    }\n\
}\n\
' > /etc/nginx/nginx.conf

# Expose ports
# 80: POD Pipeline GUI (main)
# 8080: Original POD Studio
# 8081: Music Studio
# 8188: ComfyUI API
EXPOSE 80 8080 8081 8188

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/health && curl -f http://localhost:8188/system_stats || exit 1

# Create startup script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Starting StaticWaves POD Pipeline on RunPod..."\n\
echo ""\n\
\n\
# Start ComfyUI\n\
echo "ðŸ“¦ Starting ComfyUI..."\n\
cd /workspace/ComfyUI\n\
python3 main.py --listen 0.0.0.0 --port 8188 > /var/log/comfyui.log 2>&1 &\n\
COMFYUI_PID=$!\n\
echo "ComfyUI started (PID: $COMFYUI_PID)"\n\
\n\
# Wait for ComfyUI to start\n\
echo "â³ Waiting for ComfyUI to initialize..."\n\
for i in {1..30}; do\n\
    if curl -s http://localhost:8188/system_stats > /dev/null 2>&1; then\n\
        echo "âœ… ComfyUI is ready!"\n\
        break\n\
    fi\n\
    echo "Waiting... ($i/30)"\n\
    sleep 2\n\
done\n\
\n\
# Start Nginx\n\
echo "ðŸŒ Starting Nginx web server..."\n\
nginx -g "daemon off;" > /var/log/nginx.log 2>&1 &\n\
NGINX_PID=$!\n\
echo "Nginx started (PID: $NGINX_PID)"\n\
\n\
echo ""\n\
echo "âœ… All services started successfully!"\n\
echo ""\n\
echo "ðŸ“ Access your applications:"\n\
echo "   - POD Pipeline GUI: http://localhost:80 (Main)"\n\
echo "   - Original POD Studio: http://localhost:8080"\n\
echo "   - Music Studio: http://localhost:8081"\n\
echo "   - ComfyUI API: http://localhost:8188"\n\
echo ""\n\
echo "ðŸ”§ Logs:"\n\
echo "   - ComfyUI: tail -f /var/log/comfyui.log"\n\
echo "   - Nginx: tail -f /var/log/nginx.log"\n\
echo ""\n\
\n\
# Monitor processes\n\
while true; do\n\
    if ! kill -0 $COMFYUI_PID 2>/dev/null; then\n\
        echo "âŒ ComfyUI process died, restarting..."\n\
        cd /workspace/ComfyUI\n\
        python3 main.py --listen 0.0.0.0 --port 8188 > /var/log/comfyui.log 2>&1 &\n\
        COMFYUI_PID=$!\n\
    fi\n\
    if ! kill -0 $NGINX_PID 2>/dev/null; then\n\
        echo "âŒ Nginx process died, restarting..."\n\
        nginx -g "daemon off;" > /var/log/nginx.log 2>&1 &\n\
        NGINX_PID=$!\n\
    fi\n\
    sleep 10\n\
done\n\
' > /start.sh && chmod +x /start.sh

CMD ["/start.sh"]
