# Production POD Engine Dockerfile
# Optimized for RunPod and cloud deployment

FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Metadata
LABEL maintainer="POD Engine"
LABEL description="Production POD Engine with ComfyUI and full automation pipeline"

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    NODE_ENV=production \
    COMFYUI_PATH=/workspace/ComfyUI \
    APP_PATH=/workspace/app \
    DATA_PATH=/data

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    git \
    wget \
    curl \
    lsof \
    nginx \
    nodejs \
    npm \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Create workspace and data directories
WORKDIR /workspace
RUN mkdir -p ${COMFYUI_PATH} ${APP_PATH} ${DATA_PATH}/designs ${DATA_PATH}/comfyui/output

# ===== Install ComfyUI =====
RUN git clone https://github.com/comfyanonymous/ComfyUI.git ${COMFYUI_PATH}
WORKDIR ${COMFYUI_PATH}

# Install PyTorch with CUDA support
RUN pip3 install --no-cache-dir \
    torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/cu121

# Install ComfyUI dependencies
RUN pip3 install --no-cache-dir -r requirements.txt

# Download SDXL model (optional - can be downloaded at runtime)
# Uncomment if you want to bake the model into the image
# RUN mkdir -p models/checkpoints && \
#     wget -O models/checkpoints/sd_xl_base_1.0.safetensors \
#     https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors

# ===== Install POD Engine Application =====
WORKDIR ${APP_PATH}

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production

# Copy application code
COPY . .

# Build TypeScript
RUN npm install -g tsx

# Configure Nginx (if needed for serving static files)
COPY nginx.conf /etc/nginx/nginx.conf 2>/dev/null || true

# Create startup script
RUN cat > /start.sh <<'STARTSCRIPT'
#!/bin/bash

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         POD Engine Production Container            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Start ComfyUI in background
echo "ðŸŽ¨ Starting ComfyUI..."
cd /workspace/ComfyUI
python3 main.py --listen 0.0.0.0 --port 8188 > /data/comfyui.log 2>&1 &
COMFYUI_PID=$!

# Wait for ComfyUI to be ready
echo "â³ Waiting for ComfyUI to start..."
for i in {1..30}; do
  if curl -s http://localhost:8188/system_stats > /dev/null 2>&1; then
    echo "âœ“ ComfyUI is ready"
    break
  fi
  sleep 2
done

# Start POD Engine API
echo "ðŸš€ Starting POD Engine API..."
cd /workspace/app
npm run engine &
ENGINE_PID=$!

# Wait for POD Engine to be ready
echo "â³ Waiting for POD Engine to start..."
for i in {1..30}; do
  if curl -s http://localhost:3000/health > /dev/null 2>&1; then
    echo "âœ“ POD Engine is ready"
    break
  fi
  sleep 2
done

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           All Services Started!                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Services:"
echo "  ComfyUI:    http://localhost:8188"
echo "  POD Engine: http://localhost:3000"
echo ""
echo "Logs:"
echo "  ComfyUI:   tail -f /data/comfyui.log"
echo ""

# Cleanup function
cleanup() {
  echo "ðŸ›‘ Shutting down..."
  kill $ENGINE_PID $COMFYUI_PID 2>/dev/null || true
  exit 0
}

trap cleanup SIGTERM SIGINT

# Wait for processes
wait $ENGINE_PID $COMFYUI_PID
STARTSCRIPT

RUN chmod +x /start.sh

# Expose ports
# 3000: POD Engine API
# 8188: ComfyUI API
EXPOSE 3000 8188

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:3000/health && curl -f http://localhost:8188/system_stats || exit 1

# Volume mounts for persistence
VOLUME ["/data"]

# Set working directory
WORKDIR /workspace/app

# Start services
CMD ["/start.sh"]
